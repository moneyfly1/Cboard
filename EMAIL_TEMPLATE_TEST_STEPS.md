# 邮件模板测试步骤

## 🎯 测试目标
验证所有邮件模板都能正确显示完整的订阅地址，而不是简短的代码。

## 📋 测试步骤

### 1. 管理员后台测试

#### 1.1 发送订阅地址到客户邮箱
1. 登录管理员后台
2. 进入用户管理页面
3. 找到任意用户，点击"发送订阅邮件"
4. 检查收到的邮件内容

**预期结果：**
- 邮件包含两个完整的订阅地址
- V2Ray/SSR配置地址：`https://yourdomain.com/api/v1/subscriptions/ssr/{subscription_url}`
- Clash配置地址：`https://yourdomain.com/api/v1/subscriptions/clash/{subscription_url}`
- 两个地址使用不同的样式框分开显示

#### 1.2 重置客户订阅地址
1. 在用户管理页面，点击"重置订阅地址"
2. 检查收到的邮件内容

**预期结果：**
- 邮件标题：订阅重置通知
- 包含重置时间和重置原因
- 包含两个完整的新订阅地址
- 地址格式与1.1相同

### 2. 用户操作测试

#### 2.1 用户重置订阅地址
1. 登录用户账号
2. 进入订阅管理页面
3. 点击"重置订阅地址"
4. 检查收到的邮件内容

**预期结果：**
- 邮件格式与管理员重置相同
- 重置原因为"用户重置"
- 包含两个完整的新订阅地址

#### 2.2 用户发送订阅地址到自己邮箱
1. 在用户订阅页面
2. 点击"发送到邮箱"
3. 检查收到的邮件内容

**预期结果：**
- 邮件包含当前订阅信息
- 包含两个完整的订阅地址
- 地址格式正确

### 3. 邮件内容验证

#### 3.1 订阅地址格式检查
每个邮件都应该包含：

```html
<div class="url-list">
    <div class="url-item">
        <strong>V2Ray/SSR 配置：</strong><br>
        <code class="url-code">https://yourdomain.com/api/v1/subscriptions/ssr/{subscription_url}</code>
    </div>
    <div class="url-item">
        <strong>Clash 配置：</strong><br>
        <code class="url-code">https://yourdomain.com/api/v1/subscriptions/clash/{subscription_url}</code>
    </div>
</div>
```

#### 3.2 用户信息检查
邮件应该包含动态获取的用户信息：
- 用户账号：从数据库获取的真实用户名
- 设备限制：从数据库获取的设备限制数量
- 服务期限：从数据库获取的到期时间
- 套餐信息：从数据库获取的套餐名称和描述

#### 3.3 样式检查
- 两个订阅地址应该分开显示，不能黏在一起
- 使用不同的背景色和边框区分
- 地址应该可以复制

## 🔧 技术验证

### 运行测试脚本
```bash
# 激活虚拟环境
source venv/bin/activate

# 运行邮件模板测试
python test_email_template.py
```

**预期输出：**
```
✅ 订阅信息获取成功: subscription_id=112
✅ 订阅地址生成:
   - V2Ray地址: http://localhost:8000/api/v1/subscriptions/ssr/QxZlCZSXBwVG6V4m
   - Clash地址: http://localhost:8000/api/v1/subscriptions/clash/QxZlCZSXBwVG6V4m
✅ 模板包含V2Ray/SSR配置
✅ 模板包含Clash配置
✅ 模板包含url-list样式
```

### 检查生成的模板文件
测试脚本会生成 `test_email_template.html` 文件，可以用浏览器打开查看效果。

## ❌ 常见问题排查

### 问题1：邮件中仍然显示简短代码
**原因：** 可能使用了旧的硬编码模板
**解决：** 检查是否传递了 `subscription_id` 参数

### 问题2：两个订阅地址黏在一起
**原因：** CSS样式问题
**解决：** 确保使用了 `url-list` 和 `url-item` 样式

### 问题3：用户信息显示不正确
**原因：** 数据库查询问题
**解决：** 检查数据库字段是否存在

### 问题4：订阅地址不完整
**原因：** base_url获取问题
**解决：** 检查环境变量 `DOMAIN_NAME` 是否设置

## 📝 测试记录

| 测试项目 | 测试时间 | 结果 | 备注 |
|---------|---------|------|------|
| 管理员发送订阅邮件 | | ✅/❌ | |
| 管理员重置订阅地址 | | ✅/❌ | |
| 用户重置订阅地址 | | ✅/❌ | |
| 用户发送订阅邮件 | | ✅/❌ | |
| 邮件地址格式 | | ✅/❌ | |
| 用户信息显示 | | ✅/❌ | |
| 样式显示 | | ✅/❌ | |

## 🎉 成功标准

所有测试项目都显示 ✅ 时，表示邮件模板修复完成：

1. ✅ 所有邮件都显示完整的订阅地址
2. ✅ 两个订阅地址分开显示，不黏在一起
3. ✅ 用户信息从数据库动态获取
4. ✅ 邮件样式美观，易于阅读
5. ✅ 订阅地址可以正常复制使用
