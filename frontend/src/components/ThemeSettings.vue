<template>
  <div class="theme-settings">
    <el-drawer
      v-model="visible"
      title="主题设置"
      direction="rtl"
      size="400px"
    >
      <div class="settings-content">
        <!-- 主题选择 -->
        <div class="setting-section">
          <h3 class="section-title">主题风格</h3>
          <div class="theme-grid">
            <div
              v-for="theme in themes"
              :key="theme.name"
              class="theme-item"
              :class="{ active: currentTheme === theme.name }"
              @click="selectTheme(theme.name)"
            >
              <div class="theme-preview" :style="getThemePreviewStyle(theme)">
                <div class="preview-header"></div>
                <div class="preview-sidebar"></div>
                <div class="preview-content"></div>
              </div>
              <div class="theme-info">
                <span class="theme-name">{{ theme.label }}</span>
                <span class="theme-desc">{{ getThemeDescription(theme.name) }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 布局设置 -->
        <div class="setting-section">
          <h3 class="section-title">布局设置</h3>
          <div class="setting-item">
            <span class="setting-label">侧边栏模式</span>
            <el-switch
              v-model="sidebarCollapsed"
              active-text="收起"
              inactive-text="展开"
              @change="toggleSidebar"
            />
          </div>
          <div class="setting-item">
            <span class="setting-label">紧凑模式</span>
            <el-switch
              v-model="compactMode"
              active-text="开启"
              inactive-text="关闭"
              @change="toggleCompactMode"
            />
          </div>
        </div>

        <!-- 显示设置 -->
        <div class="setting-section">
          <h3 class="section-title">显示设置</h3>
          <div class="setting-item">
            <span class="setting-label">显示面包屑</span>
            <el-switch
              v-model="showBreadcrumb"
              active-text="显示"
              inactive-text="隐藏"
              @change="toggleBreadcrumb"
            />
          </div>
          <div class="setting-item">
            <span class="setting-label">显示搜索框</span>
            <el-switch
              v-model="showSearch"
              active-text="显示"
              inactive-text="隐藏"
              @change="toggleSearch"
            />
          </div>
        </div>

        <!-- 动画设置 -->
        <div class="setting-section">
          <h3 class="section-title">动画设置</h3>
          <div class="setting-item">
            <span class="setting-label">页面切换动画</span>
            <el-switch
              v-model="pageAnimation"
              active-text="开启"
              inactive-text="关闭"
              @change="togglePageAnimation"
            />
          </div>
          <div class="setting-item">
            <span class="setting-label">加载动画</span>
            <el-switch
              v-model="loadingAnimation"
              active-text="开启"
              inactive-text="关闭"
              @change="toggleLoadingAnimation"
            />
          </div>
        </div>

        <!-- 重置设置 -->
        <div class="setting-section">
          <el-button 
            type="default" 
            @click="resetSettings"
            class="reset-btn"
          >
            <i class="el-icon-refresh"></i>
            重置所有设置
          </el-button>
        </div>
      </div>
    </el-drawer>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue'
import { themeManager } from '@/config/theme'

// Props
const props = defineProps({
  modelValue: {
    type: Boolean,
    default: false
  }
})

// Emits
const emit = defineEmits(['update:modelValue'])

// 响应式数据
const sidebarCollapsed = ref(localStorage.getItem('sidebarCollapsed') === 'true')
const compactMode = ref(localStorage.getItem('compactMode') === 'true')
const showBreadcrumb = ref(localStorage.getItem('showBreadcrumb') !== 'false')
const showSearch = ref(localStorage.getItem('showSearch') !== 'false')
const pageAnimation = ref(localStorage.getItem('pageAnimation') !== 'false')
const loadingAnimation = ref(localStorage.getItem('loadingAnimation') !== 'false')

// 计算属性
const visible = computed({
  get: () => props.modelValue,
  set: (value) => emit('update:modelValue', value)
})

const currentTheme = computed(() => themeManager.getCurrentTheme())
const themes = computed(() => themeManager.getAllThemes())

// 方法
const selectTheme = (themeName) => {
  themeManager.applyTheme(themeName)
}

const toggleSidebar = (value) => {
  localStorage.setItem('sidebarCollapsed', value)
  // 触发全局事件
  window.dispatchEvent(new CustomEvent('toggle-sidebar', { detail: value }))
}

const toggleCompactMode = (value) => {
  localStorage.setItem('compactMode', value)
  document.body.classList.toggle('compact-mode', value)
}

const toggleBreadcrumb = (value) => {
  localStorage.setItem('showBreadcrumb', value)
}

const toggleSearch = (value) => {
  localStorage.setItem('showSearch', value)
}

const togglePageAnimation = (value) => {
  localStorage.setItem('pageAnimation', value)
}

const toggleLoadingAnimation = (value) => {
  localStorage.setItem('loadingAnimation', value)
}

const resetSettings = () => {
  // 重置所有设置
  sidebarCollapsed.value = false
  compactMode.value = false
  showBreadcrumb.value = true
  showSearch.value = true
  pageAnimation.value = true
  loadingAnimation.value = true
  
  // 重置主题
  themeManager.applyTheme('default')
  
  // 清除本地存储
  localStorage.removeItem('sidebarCollapsed')
  localStorage.removeItem('compactMode')
  localStorage.removeItem('showBreadcrumb')
  localStorage.removeItem('showSearch')
  localStorage.removeItem('pageAnimation')
  localStorage.removeItem('loadingAnimation')
  
  // 移除紧凑模式类
  document.body.classList.remove('compact-mode')
  
  // 触发重置事件
  window.dispatchEvent(new CustomEvent('reset-settings'))
}

const getThemePreviewStyle = (theme) => {
  const config = theme.config
  return {
    '--preview-primary': config.primary,
    '--preview-background': config.background,
    '--preview-text': config.text,
    '--preview-border': config.border
  }
}

const getThemeDescription = (themeName) => {
  const descriptions = {
    default: '经典蓝色主题，适合大多数用户',
    dark: '深色主题，护眼舒适',
    blue: '商务蓝色主题，专业大气',
    green: '清新绿色主题，自然舒适'
  }
  return descriptions[themeName] || '自定义主题'
}
</script>

<style scoped lang="scss">
.theme-settings {
  .settings-content {
    padding: 20px;
  }
  
  .setting-section {
    margin-bottom: 30px;
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--theme-text);
      border-bottom: 1px solid var(--theme-border);
      padding-bottom: 8px;
    }
  }
  
  .theme-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    
    .theme-item {
      border: 2px solid var(--theme-border);
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      
      &:hover {
        border-color: var(--theme-primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      
      &.active {
        border-color: var(--theme-primary);
        box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.2);
      }
      
      .theme-preview {
        height: 80px;
        background: var(--preview-background);
        position: relative;
        overflow: hidden;
        
        .preview-header {
          height: 20px;
          background: var(--preview-primary);
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
        }
        
        .preview-sidebar {
          width: 30px;
          height: 60px;
          background: white;
          border-right: 1px solid var(--preview-border);
          position: absolute;
          top: 20px;
          left: 0;
        }
        
        .preview-content {
          height: 60px;
          background: var(--preview-background);
          position: absolute;
          top: 20px;
          left: 30px;
          right: 0;
        }
      }
      
      .theme-info {
        padding: 12px;
        background: white;
        
        .theme-name {
          display: block;
          font-weight: 500;
          color: var(--theme-text);
          margin-bottom: 4px;
        }
        
        .theme-desc {
          display: block;
          font-size: 12px;
          color: #666;
          line-height: 1.4;
        }
      }
    }
  }
  
  .setting-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
    
    &:last-child {
      border-bottom: none;
    }
    
    .setting-label {
      font-weight: 500;
      color: var(--theme-text);
    }
  }
  
  .reset-btn {
    width: 100%;
    height: 40px;
    
    i {
      margin-right: 8px;
    }
  }
}

// 紧凑模式样式
.compact-mode {
  :root {
    --header-height: 50px;
    --sidebar-width: 180px;
    --content-padding: 15px;
    --border-radius: 6px;
  }
  
  .el-card {
    .el-card__header {
      padding: 12px 16px;
    }
    
    .el-card__body {
      padding: 16px;
    }
  }
  
  .el-table {
    th, td {
      padding: 8px 12px;
    }
  }
  
  .el-form {
    .el-form-item {
      margin-bottom: 16px;
    }
  }
}

// 响应式设计
@media (max-width: 768px) {
  .theme-settings {
    .theme-grid {
      grid-template-columns: 1fr;
    }
    
    .setting-item {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
  }
}
</style> 