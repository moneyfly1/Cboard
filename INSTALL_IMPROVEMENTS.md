# XBoard 安装脚本改进说明

## 🚀 主要改进内容

### 1. 数据库初始化功能
- **新增功能**: 自动创建完整的数据库表结构
- **包含表**: 用户、套餐、订阅、设备、订单、支付、节点、通知等20+个核心表
- **默认数据**: 自动插入系统配置、邮件模板、示例套餐等初始数据
- **管理员账户**: 自动创建默认管理员账户 (admin@localhost / admin123)

### 2. Python依赖安装优化
- **系统依赖**: 自动安装编译所需的系统级依赖包
- **分步安装**: 分5个步骤安装Python依赖，避免编译失败
- **依赖验证**: 安装完成后验证关键依赖是否正确安装
- **自动修复**: 检测到缺失依赖时自动尝试重新安装

### 3. 数据库连接测试
- **启动前测试**: 在启动后端服务前自动测试数据库连接
- **表结构验证**: 验证数据库表是否已正确创建
- **错误诊断**: 提供详细的错误诊断信息和解决建议
- **用户选择**: 允许用户选择是否继续启动服务

### 4. 错误处理和日志
- **详细日志**: 每个步骤都有详细的成功/失败日志
- **错误恢复**: 自动尝试多种安装方法
- **用户交互**: 关键步骤提供用户选择选项
- **状态检查**: 实时检查安装状态和依赖状态

## 🔧 技术改进

### 数据库表结构
- 使用MySQL兼容的SQL语法
- 支持外键约束和索引优化
- 使用utf8mb4字符集支持完整Unicode
- 自动创建复合索引提升查询性能

### Python环境
- 支持多种Python版本 (3.8-3.12)
- 智能选择requirements文件
- 自动处理mysqlclient编译问题
- 提供pymysql作为备用MySQL驱动

### 系统兼容性
- 支持Ubuntu 18.04-24.04
- 支持CentOS/RHEL/AlmaLinux/Rocky
- 自动检测系统版本和架构
- 智能选择适合的包管理器

## 📋 安装流程

1. **系统检测**: 检测操作系统、Python版本、已安装组件
2. **系统更新**: 自动更新系统包
3. **组件安装**: 安装Python、Node.js、Nginx、MySQL、PHP
4. **项目检测**: 自动检测项目路径
5. **Python环境**: 创建虚拟环境并安装依赖
6. **前端构建**: 构建前端项目
7. **数据库配置**: 创建数据库、用户和表结构
8. **Nginx配置**: 配置反向代理
9. **环境变量**: 创建.env配置文件
10. **服务配置**: 创建systemd服务
11. **项目部署**: 部署到网站目录
12. **连接测试**: 测试数据库连接
13. **服务启动**: 启动后端服务

## ⚠️ 重要提醒

### 数据库配置
- 默认创建用户: `xboard` / `xboard123`
- 默认管理员: `admin@localhost` / `admin`
- 请及时修改默认密码

### 邮件配置
- 需要在.env文件中配置SMTP服务器信息
- 支持QQ邮箱、Gmail等主流邮件服务商

### 安全配置
- 建议配置SSL证书
- 定期备份数据库
- 修改默认管理员密码

## 🐛 故障排除

### 常见问题
1. **Python依赖安装失败**: 检查系统依赖是否完整
2. **数据库连接失败**: 检查MySQL服务状态和用户权限
3. **服务启动失败**: 查看systemd日志获取详细错误信息

### 调试命令
```bash
# 查看服务状态
systemctl status xboard

# 查看服务日志
journalctl -u xboard -f

# 测试数据库连接
mysql -u xboard -p xboard

# 检查Python环境
source venv/bin/activate
python -c "import fastapi; print('FastAPI OK')"
```

## 📚 相关文件

- `install_vps_complete.sh`: 主安装脚本
- `database_setup.sql`: 数据库结构定义
- `backend/requirements_modern.txt`: Python依赖列表
- `.env`: 环境变量配置文件
- `nginx/nginx.conf`: Nginx配置模板

## 🎯 使用建议

1. **首次安装**: 建议在全新的VPS上运行
2. **权限要求**: 需要root用户权限
3. **网络要求**: 需要稳定的网络连接下载依赖
4. **存储空间**: 建议至少2GB可用空间
5. **备份策略**: 安装完成后及时备份数据库和配置文件

---

*此改进版本解决了原安装脚本的数据库初始化缺失和依赖安装不完整等问题，确保安装后网站后端能够正常运行。*
