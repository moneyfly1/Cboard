<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试前端API</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>测试前端API调用</h1>
    
    <div>
        <h2>1. 登录获取Token</h2>
        <button onclick="testLogin()">测试登录</button>
        <div id="loginResult"></div>
    </div>
    
    <div>
        <h2>2. 创建用户</h2>
        <button onclick="testCreateUser()">测试创建用户</button>
        <div id="createUserResult"></div>
    </div>
    
    <div>
        <h2>3. 获取用户列表</h2>
        <button onclick="testGetUsers()">测试获取用户列表</button>
        <div id="getUsersResult"></div>
    </div>

    <script>
        // 配置axios
        const api = axios.create({
            baseURL: 'http://localhost:8000/api/v1',
            timeout: 10000,
            headers: {
                'Content-Type': 'application/json'
            }
        });

        // 请求拦截器
        api.interceptors.request.use(
            config => {
                const token = localStorage.getItem('token');
                if (token) {
                    config.headers.Authorization = `Bearer ${token}`;
                }
                console.log('请求:', config.method.toUpperCase(), config.url, config.data);
                return config;
            },
            error => {
                console.error('请求错误:', error);
                return Promise.reject(error);
            }
        );

        // 响应拦截器
        api.interceptors.response.use(
            response => {
                console.log('响应:', response.status, response.data);
                return response;
            },
            error => {
                console.error('响应错误:', error.response?.status, error.response?.data);
                return Promise.reject(error);
            }
        );

        async function testLogin() {
            try {
                const response = await api.post('/auth/login', 'username=admin&password=admin123', {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                
                if (response.data.access_token) {
                    localStorage.setItem('token', response.data.access_token);
                    document.getElementById('loginResult').innerHTML = 
                        `<p style="color: green;">✅ 登录成功！Token: ${response.data.access_token.substring(0, 50)}...</p>`;
                } else {
                    document.getElementById('loginResult').innerHTML = 
                        `<p style="color: red;">❌ 登录失败：没有获取到token</p>`;
                }
            } catch (error) {
                document.getElementById('loginResult').innerHTML = 
                    `<p style="color: red;">❌ 登录失败：${error.message}</p>`;
            }
        }

        async function testCreateUser() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    document.getElementById('createUserResult').innerHTML = 
                        `<p style="color: red;">❌ 请先登录获取token</p>`;
                    return;
                }

                const userData = {
                    username: 'testuser' + Date.now(),
                    email: 'test' + Date.now() + '@example.com',
                    password: 'test123',
                    is_active: true,
                    is_admin: false,
                    is_verified: false
                };

                const response = await api.post('/admin/users', userData);
                
                if (response.data.success) {
                    document.getElementById('createUserResult').innerHTML = 
                        `<p style="color: green;">✅ 创建用户成功！用户ID: ${response.data.data.user_id}</p>`;
                } else {
                    document.getElementById('createUserResult').innerHTML = 
                        `<p style="color: red;">❌ 创建用户失败：${response.data.message}</p>`;
                }
            } catch (error) {
                document.getElementById('createUserResult').innerHTML = 
                    `<p style="color: red;">❌ 创建用户失败：${error.message}</p>`;
            }
        }

        async function testGetUsers() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    document.getElementById('getUsersResult').innerHTML = 
                        `<p style="color: red;">❌ 请先登录获取token</p>`;
                    return;
                }

                const response = await api.get('/admin/users?page=1&size=5');
                
                if (response.data.data && response.data.data.users) {
                    const users = response.data.data.users;
                    document.getElementById('getUsersResult').innerHTML = 
                        `<p style="color: green;">✅ 获取用户列表成功！共${users.length}个用户</p>
                         <ul>${users.map(u => `<li>${u.username} (${u.email}) - ${u.status}</li>`).join('')}</ul>`;
                } else {
                    document.getElementById('getUsersResult').innerHTML = 
                        `<p style="color: red;">❌ 获取用户列表失败：数据格式错误</p>`;
                }
            } catch (error) {
                document.getElementById('getUsersResult').innerHTML = 
                    `<p style="color: red;">❌ 获取用户列表失败：${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
