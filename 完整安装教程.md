# XBoard 完整 VPS 安装教程

## 概述

本教程将指导您完整部署 XBoard 项目到 VPS 服务器，包括宝塔面板配置、域名设置、SSL 证书、反向代理、环境配置，以及真实支付宝 SDK 的配置。

## 系统要求

### 最低配置
- **CPU**: 1核心
- **内存**: 2GB RAM
- **存储**: 20GB SSD
- **带宽**: 1Mbps
- **操作系统**: Ubuntu 20.04+ / CentOS 7+ / Debian 10+

### 推荐配置
- **CPU**: 2核心
- **内存**: 4GB RAM
- **存储**: 40GB SSD
- **带宽**: 5Mbps
- **操作系统**: Ubuntu 22.04 LTS

## 第一步：VPS 服务器准备

### 1.1 购买 VPS 服务器

推荐 VPS 提供商：
- **阿里云 ECS**: 稳定可靠，国内访问快
- **腾讯云 CVM**: 性价比高，技术支持好
- **华为云 ECS**: 企业级服务
- **Vultr**: 海外服务器，价格便宜
- **DigitalOcean**: 开发者友好

### 1.2 系统选择

推荐选择以下系统之一：
- Ubuntu 22.04 LTS (推荐)
- Ubuntu 20.04 LTS
- CentOS 8 Stream
- Debian 11

### 1.3 安全组配置

在 VPS 控制台配置安全组，开放以下端口：
- **22**: SSH 访问
- **80**: HTTP 访问
- **443**: HTTPS 访问
- **8888**: 宝塔面板（可选）

## 第二步：宝塔面板安装

### 2.1 安装宝塔面板

```bash
# Ubuntu/Debian 系统
wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh

# CentOS 系统
yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh
```

### 2.2 宝塔面板配置

1. 安装完成后，记录面板地址、用户名和密码
2. 登录宝塔面板
3. 安装推荐软件：
   - Nginx 1.20+
   - MySQL 8.0+ (可选，本项目使用 SQLite)
   - PHP 8.0+ (可选)
   - PM2 管理器

### 2.3 宝塔面板安全设置

1. 修改面板端口（默认 8888）
2. 设置面板用户名和密码
3. 绑定域名（可选）
4. 开启面板 SSL

## 第三步：域名准备

### 3.1 购买域名

推荐域名注册商：
- **阿里云万网**: 国内用户首选
- **腾讯云 DNSPod**: 解析速度快
- **GoDaddy**: 海外用户
- **Namecheap**: 价格便宜

### 3.2 域名解析

在域名管理后台添加 A 记录：
```
类型: A
主机记录: @
记录值: 您的 VPS IP 地址
TTL: 600
```

同时添加 www 记录：
```
类型: A
主机记录: www
记录值: 您的 VPS IP 地址
TTL: 600
```

### 3.3 域名验证

等待 DNS 解析生效（通常 5-30 分钟）：
```bash
# 检查域名解析
nslookup yourdomain.com
ping yourdomain.com
```

## 第四步：运行一键安装脚本

### 4.1 下载安装脚本

```bash
# 登录 VPS
ssh root@your-vps-ip

# 下载安装脚本
wget https://raw.githubusercontent.com/moneyfly1/Cboard/master/deploy.sh

# 给脚本执行权限
chmod +x deploy.sh
```

### 4.2 运行安装脚本

```bash
# 运行安装脚本
./deploy.sh
```

安装过程中需要输入：
- 域名（例如：example.com）
- 管理员邮箱
- 管理员密码（至少 8 位）
- 支付宝配置信息（可选）

### 4.3 安装过程说明

安装脚本会自动完成以下操作：

1. **系统环境检查**
   - 检查操作系统版本
   - 检查内存和磁盘空间
   - 检查网络连接
   - 检查宝塔面板是否安装

2. **依赖安装**
   - 安装系统依赖包
   - 安装 Python 3.9+
   - 安装 Node.js 18+
   - 安装 PM2 进程管理器
   - 安装编译工具

3. **项目部署**
   - 下载项目代码
   - 创建 Python 虚拟环境
   - 安装 Python 依赖
   - 安装前端依赖
   - 构建前端项目

4. **数据库初始化**
   - 创建数据库表
   - 初始化软件识别规则
   - 创建管理员用户

5. **服务配置**
   - 配置环境变量
   - 创建 PM2 配置
   - 配置 Nginx
   - 配置防火墙

6. **宝塔面板集成**
   - 自动创建网站
   - 配置 SSL 证书
   - 设置反向代理
   - 配置伪静态规则

## 第五步：支付宝 SDK 配置

### 5.1 申请支付宝开发者账号

1. 访问 [支付宝开放平台](https://open.alipay.com/)
2. 注册并登录开发者账号
3. 创建应用，选择"网页&移动应用"
4. 获取以下信息：
   - **APPID**：应用 ID
   - **应用私钥**：商户私钥
   - **支付宝公钥**：支付宝公钥

### 5.2 配置支付宝支付

在安装脚本运行过程中，会提示您输入支付宝配置信息：

```bash
请输入支付宝 APPID: 2021001234567890
请输入支付宝应用私钥: -----BEGIN PRIVATE KEY-----
请输入支付宝公钥: -----BEGIN PUBLIC KEY-----
请输入支付宝回调地址: https://yourdomain.com/api/v1/payment/alipay/notify
请输入支付宝返回地址: https://yourdomain.com/payment/success
```

### 5.3 验证支付宝配置

配置完成后，系统会：
1. 自动测试支付宝连接
2. 验证配置信息正确性
3. 创建测试订单验证支付流程

## 第六步：宝塔面板自动配置

### 6.1 网站自动创建

安装脚本会自动在宝塔面板中：
1. 创建网站
2. 设置网站目录
3. 配置域名绑定

### 6.2 SSL 证书自动配置

1. 自动申请 Let's Encrypt 证书
2. 配置强制 HTTPS
3. 设置证书自动续期

### 6.3 反向代理自动配置

1. 配置 API 反向代理
2. 设置代理目录 `/api/`
3. 配置代理头信息

### 6.4 伪静态规则自动配置

自动添加以下伪静态规则：
```nginx
location / {
    try_files $uri $uri/ /index.html;
}

location /api/ {
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

## 第七步：服务管理

### 7.1 启动服务

```bash
cd /www/wwwroot/xboard
./start.sh
```

### 7.2 检查服务状态

```bash
# 查看 PM2 进程状态
pm2 status

# 查看服务日志
pm2 logs xboard-backend

# 查看系统资源使用
pm2 monit
```

### 7.3 服务管理命令

```bash
# 启动服务
./start.sh

# 停止服务
./stop.sh

# 重启服务
./restart.sh

# 查看状态
./status.sh
```

## 第八步：功能验证

### 8.1 访问测试

1. **前端界面**: `https://yourdomain.com`
2. **管理面板**: `https://yourdomain.com/admin`
3. **API 文档**: `https://yourdomain.com/docs`

### 8.2 支付功能测试

1. 创建测试订单
2. 选择支付宝支付
3. 验证支付二维码生成
4. 测试支付回调处理

### 8.3 设备限制功能测试

1. 登录管理面板
2. 创建测试用户和订阅
3. 使用不同设备访问订阅地址
4. 验证设备识别和限制功能

## 第九步：安全配置

### 9.1 防火墙配置

```bash
# 查看防火墙状态
ufw status

# 开放必要端口
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 8888/tcp  # 宝塔面板端口
```

### 9.2 系统安全

```bash
# 更新系统
apt update && apt upgrade -y

# 安装 fail2ban 防暴力破解
apt install fail2ban -y

# 配置 SSH 密钥登录（推荐）
# 禁用密码登录
```

### 9.3 数据库安全

```bash
# 设置数据库文件权限
chmod 600 /www/wwwroot/xboard/xboard.db
chown www:www /www/wwwroot/xboard/xboard.db
```

## 第十步：监控和维护

### 10.1 日志监控

```bash
# 查看应用日志
tail -f /www/wwwroot/xboard/logs/combined.log

# 查看 Nginx 日志
tail -f /www/wwwlogs/yourdomain.com.log

# 查看系统日志
journalctl -u nginx -f
```

### 10.2 性能监控

```bash
# 查看系统资源使用
htop

# 查看磁盘使用
df -h

# 查看内存使用
free -h
```

### 10.3 定期备份

创建备份脚本：
```bash
#!/bin/bash
# 备份脚本
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/xboard_$DATE"

mkdir -p $BACKUP_DIR

# 备份数据库
cp /www/wwwroot/xboard/xboard.db $BACKUP_DIR/

# 备份配置文件
cp /www/wwwroot/xboard/.env $BACKUP_DIR/

# 备份代码
tar -czf $BACKUP_DIR/code.tar.gz /www/wwwroot/xboard

echo "备份完成: $BACKUP_DIR"
```

设置定时备份：
```bash
# 编辑 crontab
crontab -e

# 添加每日备份任务
0 2 * * * /path/to/backup_script.sh
```

## 第十一步：故障排除

### 11.1 常见问题

#### 问题 1：服务无法启动
```bash
# 检查端口占用
netstat -tlnp | grep 8000

# 检查日志
pm2 logs xboard-backend

# 重启服务
pm2 restart xboard-backend
```

#### 问题 2：域名无法访问
```bash
# 检查 Nginx 状态
systemctl status nginx

# 检查 Nginx 配置
nginx -t

# 重启 Nginx
systemctl restart nginx
```

#### 问题 3：SSL 证书问题
```bash
# 检查证书文件
ls -la /www/server/panel/vhost/cert/yourdomain.com/

# 重新申请证书
# 在宝塔面板中重新申请 Let's Encrypt 证书
```

#### 问题 4：支付宝支付问题
```bash
# 检查支付宝配置
cat /www/wwwroot/xboard/.env | grep ALIPAY

# 检查支付日志
tail -f /www/wwwroot/xboard/logs/payment.log
```

### 11.2 性能优化

#### 数据库优化
```bash
# 定期清理日志
pm2 flush

# 优化数据库
sqlite3 /www/wwwroot/xboard/xboard.db "VACUUM;"
```

#### Nginx 优化
```nginx
# 在 Nginx 配置中添加
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
```

## 第十二步：高级配置

### 12.1 负载均衡

如果需要多服务器部署：
```nginx
upstream xboard_backend {
    server 127.0.0.1:8000;
    server 127.0.0.1:8001;
    server 127.0.0.1:8002;
}

server {
    location /api/ {
        proxy_pass http://xboard_backend;
    }
}
```

### 12.2 CDN 配置

使用 CDN 加速静态资源：
1. 在 CDN 提供商配置域名
2. 设置缓存规则
3. 配置回源地址

### 12.3 邮件服务配置

配置 SMTP 邮件服务：
```bash
# 编辑 .env 文件
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=your-email@gmail.com
SMTP_PASSWORD=your-app-password
SMTP_USE_TLS=True
```

## 第十三步：项目特色功能

### 13.1 设备限制系统

- 支持 24 种主流订阅软件识别
- 智能设备指纹算法
- 同设备不同 IP 处理
- 设备管理界面

### 13.2 软件识别支持

#### iOS 软件
- Shadowrocket
- Quantumult X
- Surge
- Loon
- Stash
- Sparkle

#### Android 软件
- Clash Meta for Android
- V2rayNG
- SagerNet
- Matsuri
- AnXray
- Nekobox

#### Windows 软件
- Clash for Windows
- v2rayN
- FlClash
- Clash Verge

#### macOS 软件
- ClashX Pro
- Clash for Mac

### 13.3 管理功能

- 用户管理
- 订阅管理
- 设备管理
- 访问日志
- 统计报表

## 第十四步：支付宝真实环境配置

### 14.1 生产环境配置

在生产环境中，需要配置真实的支付宝参数：

```bash
# 在 .env 文件中配置
ALIPAY_APP_ID=你的真实APPID
ALIPAY_PRIVATE_KEY=你的真实应用私钥
ALIPAY_PUBLIC_KEY=支付宝公钥
ALIPAY_NOTIFY_URL=https://yourdomain.com/api/v1/payment/alipay/notify
ALIPAY_RETURN_URL=https://yourdomain.com/payment/success
ALIPAY_DEBUG=false
```

### 14.2 沙箱环境测试

在开发测试阶段，可以使用支付宝沙箱环境：

```bash
# 沙箱环境配置
ALIPAY_APP_ID=沙箱APPID
ALIPAY_PRIVATE_KEY=沙箱应用私钥
ALIPAY_PUBLIC_KEY=沙箱支付宝公钥
ALIPAY_NOTIFY_URL=http://localhost:8000/api/v1/payment/alipay/notify
ALIPAY_RETURN_URL=http://localhost:3000/payment/success
ALIPAY_DEBUG=true
```

### 14.3 支付回调处理

系统会自动处理支付宝支付回调：

1. 验证回调签名
2. 更新订单状态
3. 创建用户订阅
4. 发送支付成功通知

## 总结

通过本教程，您可以完整部署 XBoard 项目，包括：

1. ✅ VPS 服务器配置
2. ✅ 宝塔面板安装和配置
3. ✅ 域名配置和 SSL 证书
4. ✅ 项目自动部署
5. ✅ 支付宝 SDK 配置
6. ✅ 服务配置和管理
7. ✅ 安全配置
8. ✅ 监控和维护
9. ✅ 故障排除

项目部署完成后，您将拥有一个功能完整的设备限制系统，支持所有主流订阅软件的精确识别和管理，以及真实的支付宝支付功能。

## 技术支持

如果在部署过程中遇到问题，请：

1. 检查日志文件
2. 查看错误信息
3. 参考故障排除部分
4. 联系技术支持

**项目地址**: https://github.com/moneyfly1/Cboard
**文档地址**: https://github.com/moneyfly1/Cboard/wiki
